# pull official base image
FROM python:3.8.15-alpine

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

RUN apk update && apk add python3-dev gcc libc-dev libpq-dev

WORKDIR /app

RUN pip install --upgrade pip
ADD ./requirements.txt /app/
RUN pip install -r requirements.txt

ADD ./backend /app/backend
ADD ./docker /app/docker

ARG DJANGO_SECRET
ARG DJANGO_POSTGRES_NAME
ARG DJANGO_POSTGRES_USER
ARG DJANGO_POSTGRES_PASSWORD
ARG DJANGO_POSTGRES_HOST
ARG DJANGO_POSTGRES_PORT
ARG DJANGO_REDIS_CACHE_LOC
ARG DJANGO_REDIS_PORT
ARG DJANGO_REDIS_CACHE_KEY_PREFIX
ARG DJANGO_CELERY_BROKER
ARG DJANGO_CELERY_RESULT_BACKEND

ENV DJANGO_SECRET ${DJANGO_SECRET}
ENV DJANGO_POSTGRES_NAME ${DJANGO_POSTGRES_NAME}
ENV DJANGO_POSTGRES_USER ${DJANGO_POSTGRES_USER}
ENV DJANGO_POSTGRES_PASSWORD ${DJANGO_POSTGRES_PASSWORD}
ENV DJANGO_POSTGRES_HOST ${DJANGO_POSTGRES_HOST}
ENV DJANGO_POSTGRES_PORT ${DJANGO_POSTGRES_PORT}
ENV DJANGO_REDIS_CACHE_LOC ${DJANGO_REDIS_CACHE_LOC}
ENV DJANGO_REDIS_PORT ${DJANGO_REDIS_PORT}
ENV DJANGO_REDIS_CACHE_KEY_PREFIX ${DJANGO_REDIS_CACHE_KEY_PREFIX}
ENV DJANGO_CELERY_BROKER ${DJANGO_CELERY_BROKER}
ENV DJANGO_CELERY_RESULT_BACKEND ${DJANGO_CELERY_RESULT_BACKEND}

RUN chmod +x /app/docker/backend/server-entrypoint.sh